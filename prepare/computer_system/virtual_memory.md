# 虚拟内存机制

## 虚拟内存机制，二级页表，TLB快表，缺页，swap

## 内存管理

区分物理内存和虚拟内存：

1. 物理内存：指实际的内存，CPU使用物理地址来访问主存中的数据；
2. 虚拟内存：每个进程都拥有自己的虚拟地址空间，地址是虚拟内存。实际访问主存时，有内存管理单元MMU将虚拟地址转换为物理地址。

**虚拟内存的目的**是为了让物理内存扩充成更大的逻辑内存，从而让程序获得更多的可用内存。也为了虚拟化机器，让程序不要绑定固定的内存地址空间。

为了应对内存碎片的问题，使用分页机制来管理内存。

- 分页
- 页表
- 多级页表

## 虚拟内存到物理地址的映射过程

虚拟地址包含两部分，一部分是储存页面号，另一部分是储存偏移量。储存页面号可以在页表中寻找到该页，储存偏移量用来在该页中寻找到需要的内存。

1. 进程将虚拟地址传给CPU，CPU将地址传递给内存管理单元MMU；
2. MMU首先检查TLB，如果存在该虚拟地址映射，直接返回该映射；
3. 如果不存在，就访问页表，首先通过进程的页表基址和虚拟地址计算页表项的物理地址，然后就访问内存，取出页表项，并将其放置到TLB；
4. 得到映射/页表项后，如果对应的数据没有存储到内存，就引起一次**缺页中断**，将对应的内容放置到内存中。
5. 将物理地址传递给主存，主存返回对应数据。

## 缺页置换算法

1. **最佳**：选出最长时间内不再被访问的页面，通常可以保证获得最低的缺页率；
2. **最近最久未使用LRU**：将最近最久未使用的页面换出。需要在内存中维持一个链表，当一个页表被访问时将其移动到表头，保证每次链表最后一个元素是最近最久未使用的。
3. **最近未使用**：每个页面设置两个状态为 R 和 M ，当页面被使用时设置 R = 1，当页面被修改时设置 M=1 ，定期清零R，当发生缺页中断时，NRU算法优先从类编号最小的非空类中选择一个页面将它换出。NRU优先换出 R=0,M=1 的脏页面，而不是R=1,M=0的经常读写的干净数据。
4. **先进先出 FIFO**：最先进入的最先被换出

## 分段

虚拟内存采用的是分页技术，将地址空间映射为大小固定的页，每一页与内存进行映射。

## 缓存算法

1. 先进先出（FIFO）
2. 最近最久未使用（LRU）
3. 最近很少使用（LFU）：与LRU不同，LFU是基于访问次数的
4. 最佳的（OPT）：是一种理论上最佳的页面置换算法。它的思想是，试图淘汰掉以后永远也用不到的页面，如果没有则淘汰最久以后再用到的页面。因为这种算法必须知道进程访问页面的序列，而这是无法实现的，因此仅有理论意义。
