# 分布式事务

分布式事务就是指事务的参与者、支持事务的服务器、资源服务器以及事务管理器分别位于不同的分布式系统的不同节点之上。简单的说，就是一次大的操作由不同的小操作组成，这些小的操作分布在不同的服务器上，且属于不同的应用，分布式事务需要保证这些小操作要么全部成功，要么全部失败。本质上来说，分布式事务就是为了保证不同数据库的数据一致性。

## 产生原因

1. 有多个 service 节点，比如微服务拆分后，用户的资产被分为好多个模块：余额、积分、优惠券等。
2. 有多个资源节点

## 理论基础

### CAP

CAP 指的是一下三种特性：

1. 一致性(强一致性、弱一致性、最终一致性)
2. 可用性
3. 分区容错性

CAP 三者不能共有：

- **CA without P**：如果不要求P（不允许分区），则C（强一致性）和A（可用性）是可以保证的。但其实分区不是你想不想的问题，而是始终会存在，因此CA的系统更多的是允许分区后各子系统依然保持CA。
- **CP without A**：如果不要求A（可用），相当于每个请求都需要在Server之间强一致，而P（分区）会导致同步时间无限延长，如此CP也是可以保证的。很多传统的数据库分布式事务都属于这种模式。
- **AP wihtout C**：要高可用并允许分区，则需放弃一致性。一旦分区发生，节点之间可能会失去联系，为了高可用，每个节点只能用本地数据提供服务，而这样会导致全局数据的不一致性。现在众多的NoSQL都属于此类。

### BASE

BASE 理论：

1. 基本可用(Basically Avilable)
2. 软状态(Soft State)
3. 最终一致性(Eventally Consistent)

## 常见事务协议

### 两阶段提交协议 2PC

### 三阶段提交协议 3PC

## 参考

1.[分布式事务](https://juejin.im/post/5aa3c7736fb9a028bb189bca#heading-10)
