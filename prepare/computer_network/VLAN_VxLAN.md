# 虚拟网络

## VLAN

VLAN 会使用 12 比特表示虚拟网络 ID，虚拟网络的上限是 4096 个。

## VxLAN

4096 个虚拟网络对于大规模的数据中心来说远远不够，VxLAN 会使用 24 比特的 VNI 表示虚拟网络个数，总共可以表示 16,777,216 个虚拟网络，这也就能满足数据中心多租户网络隔离的需求了。

### VxLAN 原理

1. 绿色的 10.0.0.1 会将 IP 数据包发送给 VTEP；
2. 服务器 1 的 VTEP 收到 10.0.0.1 发送的数据包后；
   1. 从收到的 IP 数据包中获取目的虚拟机的 MAC 地址；
   2. 在本地的转发表中查找该 MAC 地址所在服务器的 IP 地址，即 204.79.197.200；
   3. 将绿色虚拟机所在的虚拟网络标识符（VxLAN Network Identifier、VNI）以及原始的 IP 数据包作为负载，构建新的 UDP 数据包；
   4. 将新的 UDP 数据包发送到网络中；
3. 服务器 2 的 VTEP 收到 UDP 数据包后；
   1. 去掉 UDP 数据包中的协议头；
   2. 查看数据包中 VNI；
   3. 将 IP 数据包转发给目标的绿色服务器 10.0.0.2；
4. 绿色的 10.0.0.2 会收到绿色服务器 10.0.0.1 发送的数据包；

在数据包的传输过程中，通信的双方都不知道底层网络做的这些转换，它们认为两者可以通过二层的网络互相访问，但是实际上经过了三层 IP 网络的中转，通过 VTEP 之间建立的隧道实现了连通。除了 VxLAN 之外，Overlay 网络还有很多实现方案，不过也都大同小异。Overlay 网络虽然能够利用底层网络在多数据中心之间组成二层网络，但是它的封包和拆包过程也会带来额外开销

### VxLAN 总结

今天的数据中心包含多个集群以及海量的物理机，Overlay 网络是虚拟机和底层网络设备之间的中间层，通过 Overlay 网络这一个中间层，我们可以解决虚拟机的迁移问题、降低二层核心网络设备的压力并提供更大规模的虚拟网络数量：

1. 在使用 VxLAN 构成二层网络中，虚拟机在不同集群、不同可用区和不同数据中心迁移后，仍然可以保证二层网络的可达性，这能够帮助我们保证线上业务的可用性、提升集群的资源利用率、容忍虚拟机和节点的故障；
2. 集群中虚拟机的规模可能是物理机是几十倍，与物理机构成的传统集群相比，虚拟机构成的集群包含的 MAC 地址数量可能多一两个数量级，网络设备很难承担如此大规模的二层网络请求，Overlay 网络通过 IP 封包和控制平面可以减少集群中的 MAC 地址表项和 ARP 请求；
3. VxLAN 的协议头使用 24 位的 VNI 表示虚拟网络，总共可以表示 1600 万的虚拟网络，我们可以为不同的虚拟网络单独分配网络带宽，满足多租户的网络隔离需求；

## Reference

1. [为什么集群需要 Overlay 网络](https://mp.weixin.qq.com/s?__biz=MzAwNTQ4MTQ4NQ==&mid=2453568122&idx=2&sn=cd092a5e23227996bf889c26cb6b0774&chksm=8cd12f18bba6a60edb7b3b1274e80090baddf14a46c5cc249e77352ff045af972f2223c20304&scene=126&sessionid=1596463234&key=d65a15a3ec10db972e58eb999524b4fa22a9a49545da1e0312069a880c1b271a705cd3729d433d6bb91c112d2930f200eada397a771e4e0cd2d3449420a56e6648dddfa0c456f824964e487aa3dd5b13&ascene=1&uin=MjM1Mzc3NDI2Mw%3D%3D&devicetype=Windows+10+x64&version=62090529&lang=zh_CN&exportkey=AbJp4Ugf8V%2BgPQWo7Lc7plE%3D&pass_ticket=3ugGQaS1VPPM0e2ZroNyMA8RZS5ue4PVxOr3HtPZXcjW2Yeuqin8%2Bb7wsT8Zj2oa)
