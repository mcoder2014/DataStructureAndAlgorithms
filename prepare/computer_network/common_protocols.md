# 网络协议

## 网络模型

### 七层模型

1. 物理层
2. 数据链路层 **数据帧**
3. 网络层 **数据报** (IP ICMP ARP RARO AKP UUCP)
4. 运输层 **报文段/用户数据报** (TCP UDP)
5. 会话层 (SMTP DNS)
6. 表示层 (Telnet )
7. 应用层 (HTTP FTP NFS)

### 五层模型

1. 物理层
2. 数据链路层
3. 网络层
4. 运输层
5. 应用层

## TCP/IP协议 四层模型

1. 数据链路层
2. 网络层
3. 传输层
4. 应用层

## 常见协议

运行在TCP协议上的协议：

* HTTP（Hypertext Transfer Protocol，超文本传输协议），主要用于普通浏览。
* HTTPS（Hypertext Transfer Protocol over Secure Socket Layer, or HTTP over SSL，安全超文本传输协议）,HTTP协议的安全版本。
* FTP（File Transfer Protocol，文件传输协议），由名知义，用于文件传输。
* POP3（Post Office Protocol, version 3，邮局协议），收邮件用。
* SMTP（Simple Mail Transfer Protocol，简单邮件传输协议），用来发送电子邮件。
* TELNET（Teletype over the Network，网络电传），通过一个终端（terminal）登陆到网络。
* SSH（Secure Shell，用于替代安全性差的TELNET），用于加密安全登陆用。

运行在UDP协议上的协议：

* NTP（Network Time Protocol，网络时间协议），用于网络同步。
* DHCP（Dynamic Host Configuration Protocol，动态主机配置协议），动态配置IP地址。

其他：

* DNS（Domain Name Service，域名服务），用于完成地址查找，邮件转发等工作（运行在TCP和UDP协议上）。
* ECHO（Echo Protocol，回绕协议），用于查错及测量应答时间（运行在TCP和UDP协议上）。
* SNMP（Simple Network Management Protocol，简单网络管理协议），用于网络信息的收集和网络管理。
* ARP（Address Resolution Protocol，地址解析协议），用于动态解析以太网硬件的地址。

### DHCP

DHCP（动态主机配置协议）是一个局域网的网络协议。指的是由服务器控制一段IP地址范围，客户机登录服务器时就可以自动获得服务器分配的IP地址和子网掩码。

#### DHCP 工作流程

1. 发现阶段，即DHCP客户机寻找DHCP服务器的阶段。**DHCP客户机以广播方式**（因为DHCP服务器的IP地址对于客户机来说是未知的）发送DHCP discover发现信息来寻找DHCP服务器，即向地址255.255.255.255发送特定的广播信息。网络上每一台安装了TCP/IP协议的主机都会接收到这种广播信息，但只有DHCP服务器才会做出响应。

2. 提供阶段，即DHCP服务器提供IP地址的阶段。在网络中接收到DHCP discover发现信息的DHCP服务器都会做出响应，**它从尚未出租的IP地址中挑选一个分配给DHCP客户机，向DHCP客户机发送一个包含出租的IP地址和其他设置的DHCP offer提供信息。**

3. 选择阶段，即DHCP客户机选择某台DHCP服务器提供的IP地址的阶段。如果有多台DHCP服务器向DHCP客户机发来的DHCP offer提供信息，则DHCP客户机只接受第一个收到的DHCP offer提供信息，然后**它就以广播方式回答一个DHCP request请求信息，该信息中包含向它所选定的DHCP服务器请求IP地址的内容。**之所以要以广播方式回答，是为了通知所有的DHCP服务器，他将选择某台DHCP服务器所提供的IP地址。

4. 确认阶段，即DHCP服务器确认所提供的IP地址的阶段。当DHCP服务器收到DHCP客户机回答的DHCP request请求信息之后，**它便向DHCP客户机发送一个包含它所提供的IP地址和其他设置的DHCP ack确认信息，告诉DHCP客户机可以使用它所提供的IP地址。然后DHCP客户机便将其TCP/IP协议与网卡绑定，**另外，除DHCP客户机选中的服务器外，其他的DHCP服务器都将收回曾提供的IP地址。

5. **重新登录。以后DHCP客户机每次重新登录网络时，就不需要再发送DHCP discover发现信息了，而是直接发送包含前一次所分配的IP地址的DHCP request请求信息。当DHCP服务器收到这一信息后，它会尝试让DHCP客户机继续使用原来的IP地址，并回答一个DHCP ack确认信息。**如果此IP地址已无法再分配给原来的DHCP客户机使用时（比如此IP地址已分配给其它DHCP客户机使用），则DHCP服务器给DHCP客户机回答一个DHCP nack否认信息。当原来的DHCP客户机收到此DHCP nack否认信息后，它就必须重新发送DHCP discover发现信息来请求新的IP地址。

6. 更新租约。**DHCP服务器向DHCP客户机出租的IP地址一般都有一个租借期限，期满后DHCP服务器便会收回出租的IP地址。如果DHCP客户机要延长其IP租约，则必须更新其IP租约。DHCP客户机启动时和IP租约期限过一半时，DHCP客户机都会自动向DHCP服务器发送更新其IP租约的信息。**

### ARP RARP

#### ARP 协议

Address Resolution Protocol，地址解析协议，工作在网络层 ( IP 层)

用于实现从 IP 地址到 MAC 地址的映射，即询问目标IP对应的MAC地址。

##### ARP 协议工作流程

主机A的IP地址为192.168.1.1，MAC地址为0A-11-22-33-44-01；

主机B的IP地址为192.168.1.2，MAC地址为0A-11-22-33-44-02；

当主机A要与主机B通信时，地址解析协议可以将主机B的IP地址（192.168.1.2）解析成主机B的MAC地址，以下为工作流程：

1. 根据主机A上的路由表内容，IP确定用于访问主机B的转发IP地址是192.168.1.2。**然后A主机在自己的本地ARP缓存中检查主机B的匹配MAC地址。**
2. **如果主机A在ARP缓存中没有找到映射**，它将询问192.168.1.2的硬件地址，从而**将ARP请求帧广播到本地网络上的所有主机。**源主机A的IP地址和MAC地址都包括在ARP请求中。本地网络上的每台主机都接收到ARP请求并且检查是否与自己的IP地址匹配。**如果主机发现请求的IP地址与自己的IP地址不匹配，它将丢弃ARP请求。**
3. **主机B确定ARP请求中的IP地址与自己的IP地址匹配，则将主机A的IP地址和MAC地址映射添加到本地ARP缓存中。**
4. **主机B将包含其MAC地址的ARP回复消息直接发送回主机A。**
5. **当主机A收到从主机B发来的ARP回复消息时，会用主机B的IP和MAC地址映射更新ARP缓存。**本机缓存是有生存期的，生存期结束后，将再次重复上面的过程。主机B的MAC地址一旦确定，主机A就能向主机B发送IP通信了。

#### RARP 协议

Reverse Address Resolution Protocol，逆地址解析协议，工作在网络层 ( IP 层)

RARP使用与ARP相同的报头结构，作用与ARP相反。RARP**用于将MAC地址转换为IP地址**。可应用于无盘系统。

##### 工作流程

1. 发送主机发送一个本地的RARP广播，在此广播包中，声明自己的MAC地址并且请求任何收到此请求的RARP服务器分配一个IP地址；
2. 本地网段上的RARP服务器收到此请求后，检查其RARP列表，查找该MAC地址对应的IP地址；
3. 如果存在，RARP服务器就给源主机发送一个响应数据包并将此IP地址提供给对方主机使用；
4. 如果不存在，RARP服务器对此不做任何的响应；
5. 源主机收到从RARP服务器的响应信息，就利用得到的IP地址进行通讯；如果一直没有收到RARP服务器的响应信息，表示初始化失败。

### TCP/UDP

TCP 和 UDP 工作在传输层，TCP 面向有连接的可靠的传输协议， UDP 是面向无连接的，不可靠的传输协议。

### 邮件协议

#### SMTP

#### POP3

#### IMAP4

### FTP

文件传输协议，工作在应用层。

该协议是Internet文件传送的基础，它由一系列规格说明文档组成，目标是提高文件的共享性，提供非直接使用远程计算机，使存储介质对用户透明和可靠高效地传送数据。简单的说，FTP就是完成两台计算机之间的拷贝，从远程计算机拷贝文件至自己的计算机上，称之为“下载 （download）”文件。若将文件从自己计算机中拷贝至远程计算机上，则称之为“上载（upload）”文件。在TCP/IP协议中，FTP标准命令TCP端口号为21，Port方式数据端口为20。

#### FTP 工作原理

FTP有两个过程一个是控制连接，一个是数据传输。FTP协议不像HTTP协议一样需要一个端口作为连接（默认时HTTP端口是80，FTP端口是21）。FTP协议需要两个端口，一个端口是作为控制连接端口，也就是FTP的21端口，用于发送指令给服务器以及等待服务器响应；另外一个端口用于数据传输端口，端口号为20（仅用PORT模式），是用建立数据传输通道的，主要作用是从客户向服务器发送一个文件，从服务器向客户发送一个文件，从服务器向客户发送文件或目录列表。

#### FTP 工作流程

1. **建立连接阶段：**该阶段是 FTP 客户端通过 TCP 三次握手与FTP服务器端进行建立连接。客户端向 FTP 服务器发出建立连接请求，FTP 服务器对请求进行应答。如果 FTP 服务器上的 21 端口是启用的，可以接受来自其他主机的请求，给出应答 220，表示服务就绪，即告诉客户端需要的 FTP 服务已经准备好了。返回应答以后，FTP 服务器需要客户端进行身份认证，向客户端发送身份认证请求。
2. **身份认证阶段：**身份认证是指客户端需要向FTP服务提供登录所需的用户名和密码。FTP 服务器对客户端输入的用户名和密码都会给出相应的应答。如果客户端输入的用户名和密码正确，将成功登录FTP服务器，此时进入 FTP 会话。
3. **命令交互阶段：** 在 FTP 会话中，用户可以执行 FTP 命令进行文件传输，如查看目录信息、上传或下载文件等。客户端输入要执行的 FTP 命令后，服务器同样会给出应答。如果输入的执命令正确，服务器会将命令的执行结果返回给客户端。执行结果返回完成后，服务器继续给出应答。
4. **断开连接阶段：** 当客户端不再与 FTP 服务器进行文件传输时，需要断开连接。客户端向 FTP 服务器发送断开连接请求，服务器收到断开连接后给出相应的应答。

### HTTP 协议

超文本传输协议，工作在 应用层.

### DNS

DNS 协议工作在应用层。

### Telnet

Telnet是位于OSI模型的第7层---应用层上的一种协议，是一个通过创建虚拟终端提供连接到远程主机终端仿真的TCP/IP协议。这一协议需要通过用户名和口令进行认证，是Internet远程登陆服务的标准协议。应用Telnet协议能够把本地用户所使用的计算机变成远程主机系统的一个终端。它提供了三种基本服务：

1. Telnet定义一个网络虚拟终端为远程系统提供一个标准接口。客户机程序不必详细了解远程系统，他们只需构造使用标准接口的程序；
2. Telnet包括一个允许客户机和服务器协商选项的机制，而且它还提供一组标准选项；　.
3. Telnet对称处理连接的两端，即Telnet不强迫客户机从键盘输入，也不强迫客户机在屏幕上显示输出。

#### Telnet 如何处理特殊功能键

**NVT** ： Telnet同样使用NVT来定义如何从客户机将控制功能传送到服务器。我们知道ASCⅡ字符集包括95个可打印字符和33个控制码。当用户从本地键入普通字符时，NVT将按照其原始含义传送；当用户键入快捷键（组合键）时，NVT将把它转化为特殊的ASCⅡ字符在网络上传送，并在其到达远地机器后转化为相应的控制命令。

## 参考文献

1. [TCP/IP 协议族 wiki](https://zh.wikipedia.org/wiki/TCP/IP%E5%8D%8F%E8%AE%AE%E6%97%8F)